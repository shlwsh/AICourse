# 项目开发规则

## 语言规范

### 规则 1：中文优先
- **所有回复必须使用中文**
- **所有文档必须使用中文编写**，包括但不限于：
  - 需求文档（requirements.md）
  - 设计文档（design.md）
  - 任务列表（tasks.md）
  - README 文件
  - 代码注释
  - API 文档
  - 用户手册

## 技术栈规范

### 规则 2：使用 Bun 框架

本项目使用 Bun 作为 JavaScript/TypeScript 运行时和包管理器：

- **包管理**：使用 `bun add`、`bun remove` 等命令管理依赖，禁止使用 `npm` 或 `yarn`
- **脚本执行**：使用 `bun run` 执行脚本，禁止使用 `npm run`
- **包执行**：使用 `bunx` 执行包命令，禁止使用 `npx`
- **测试运行**：使用 `bunx playwright` 运行 Playwright 测试

**实施要求**：
- 所有 package.json 脚本必须使用 `bun` 命令
- 所有文档和脚本中的命令示例必须使用 `bun`
- Shell 脚本中使用 `bunx` 而不是 `npx`
- 不得在项目中混用 npm/yarn 和 bun

**示例**：
```bash
# 正确 ✓
bun add express
bun run dev
bunx playwright test

# 错误 ✗
npm install express
npm run dev
npx playwright test
```

## 日志记录规范

### 规则 3：完善的日志记录
所有模块必须实现完善的日志记录功能：

- **日志级别**：使用标准日志级别（DEBUG、INFO、WARN、ERROR）
- **日志内容**：记录关键操作、错误信息、性能指标
- **日志格式**：包含时间戳、日志级别、模块名称、消息内容
- **日志输出**：支持控制台输出和文件输出
- **敏感信息**：不得在日志中记录密码、密钥等敏感信息

**实施要求**：
- 每个模块/类都应该有独立的日志记录器
- 在关键业务逻辑的入口和出口处添加日志
- 异常处理时必须记录详细的错误信息和堆栈跟踪
- 重要的状态变更必须记录日志

## 测试规范

### 规则 4：使用 Playwright 进行前端和集成测试

- **前端测试**：使用 Playwright 框架进行 UI 测试
- **集成测试**：使用 Playwright 框架进行端到端测试
- **测试覆盖**：确保关键用户流程都有对应的测试用例

**Playwright 测试要求**：
- 测试文件命名：`*.spec.ts` 或 `*.test.ts`
- 使用 Page Object Model 模式组织测试代码
- 测试应该独立且可重复执行
- 使用有意义的测试描述
- 适当使用等待和断言确保测试稳定性

### 规则 5：集成测试执行流程

**顺序执行与错误处理**：
- **按用例顺序执行**：集成测试必须按照预定义的用例顺序依次执行
- **快速失败机制**：一旦某个用例执行失败，立即停止后续测试
- **进入修正流程**：测试失败后，必须：
  1. 分析失败原因并记录详细日志
  2. 修正代码或测试用例
  3. 重新运行失败的用例进行验证
  4. 确认修正通过后，才能继续执行下一个用例
- **验证通过标准**：只有当前用例完全通过（所有断言成功），才能进入下一个用例

**实施要求**：
- 测试用例应该有明确的执行顺序编号
- 每个用例执行前记录开始日志，执行后记录结果
- 失败时输出清晰的错误信息和失败位置
- 修正后必须从失败的用例重新开始执行
- 不允许跳过失败的用例继续执行后续测试

## 运行环境规范

### 规则 6：双模式兼容

本项目必须同时支持 Tauri 桌面应用和浏览器 Web 应用两种运行模式：

- **Tauri 模式**：通过 `bun run dev` 或 `tauri dev` 启动的桌面应用
- **浏览器模式**：直接在浏览器中访问 `http://localhost:5173` 的 Web 应用

**实施要求**：
- 所有功能必须在两种模式下都能正常使用
- 需要根据运行环境自动适配不同的实现方式
- 文件操作功能：
  - Tauri 模式：**避免使用 Tauri 对话框 API（存在阻塞问题）**，使用浏览器标准机制
  - 浏览器模式：使用浏览器的下载机制和 File API
- 环境检测：使用 `window.__TAURI__` 判断是否在 Tauri 环境中
- 日志记录：在环境检测和模式切换时记录详细日志

**重要提示 - Tauri 对话框 API 问题**：
- Tauri 1.5 的 `dialog.save()` 和 `dialog.open()` API 存在严重的阻塞问题
- 调用这些 API 会导致应用卡死，对话框无法显示
- **解决方案**：在 Tauri 环境下也使用浏览器的标准下载机制
- 文件下载：使用 `<a>` 标签触发下载，文件保存到默认下载目录
- 文件上传：使用标准 HTML `<input type="file">` 元素

**示例**：
```typescript
// 环境检测
const isTauri = typeof window !== 'undefined' && (window as any).__TAURI__;

if (isTauri) {
  // Tauri 模式：使用浏览器标准下载（避免对话框 API）
  const link = document.createElement('a');
  link.href = url;
  link.download = 'file.xlsx';
  link.click();
} else {
  // 浏览器模式：使用传统下载
  const link = document.createElement('a');
  link.href = url;
  link.download = 'file.xlsx';
  link.click();
}
```

**测试要求**：
- 每个功能都需要在两种模式下分别测试
- 确保用户体验在两种模式下保持一致
- 特别关注文件上传、下载、本地存储等涉及文件系统的功能

## 文档规范

### 规则 7：专注代码开发，避免过度文档化

- **非必要不生成文档**：除非用户明确要求，否则不要自动生成 Markdown 文档
- **禁止生成的文档类型**：
  - 工作总结文档（summary.md、report.md 等）
  - 实现过程记录文档
  - 变更日志文档（除非是项目级别的 CHANGELOG.md）
  - 临时性的说明文档
- **允许生成的文档**：
  - 用户明确要求的文档
  - 项目必需的 README.md
  - API 文档（当实现新的 API 时）
  - 架构设计文档（当进行重大架构变更时）

**实施要求**：
- 完成任务后，直接给出简短的文字总结，不要创建 Markdown 文件
- 代码注释应该清晰完整，减少对外部文档的依赖
- 专注于代码质量和功能实现，而非文档数量

---

**注意**：这些规则适用于整个项目的开发过程，所有代码、文档和测试都必须遵循以上规范。
