# 需求文档：排课系统

## 简介

排课系统是一个基于约束优化问题（COP）的智能课程调度系统，用于自动生成和管理学校课程表。系统需要同时满足硬约束（必须满足的规则）和软约束（尽量优化的偏好），并提供可视化的手动调课功能。系统采用 Bun + Rust + Tauri 架构，使用 SQLite 作为数据存储，通过位掩码（Bitmask）技术实现高性能的时间槽位表示。

## 术语表

- **排课系统（System）**: 整个课程调度应用程序
- **约束求解器（Solver）**: 负责生成满足约束条件的课表的 Rust 后端模块
- **硬约束（Hard_Constraint）**: 绝对不能违反的规则，违反则课表无效
- **软约束（Soft_Constraint）**: 尽量满足的偏好，违反会降低课表评分但不影响有效性
- **时间槽位（TimeSlot）**: 一周内的具体上课时段，由星期和节次组成
- **时间槽位掩码（TimeSlotMask）**: 使用 u64 位掩码表示一周的时间槽位（5天 × 8节 = 40位）
- **代价函数（Cost_Function）**: 计算课表质量的评分函数，代价越低课表越优
- **教师偏好（Teacher_Preference）**: 教师对上课时段的个性化偏好配置
- **课程配置（Subject_Config）**: 科目的约束规则配置
- **教学计划（Class_Curriculum）**: 班级的课程安排计划，包含科目、教师和课时数
- **调课引擎（Rescheduling_Engine）**: 处理手动调课和交换建议的模块
- **冲突检测器（Conflict_Detector）**: 检测课表冲突的前端可视化模块
- **交换建议器（Swap_Suggester）**: 提供智能课程交换方案的模块
- **设置向导（Setup_Wizard）**: 引导用户配置系统规则和教师信息的界面
- **热力图（Heatmap）**: 可视化显示软约束违反程度的课表视图

## 需求

### 需求 1：硬约束管理

**用户故事：** 作为教务主任，我希望系统能够强制执行不可违反的排课规则，以确保生成的课表符合学校的基本要求。

#### 验收标准

1. WHEN 约束求解器生成课表 THEN 排课系统 SHALL 确保体育、音乐、美术课程不被安排在第1-3节
2. WHEN 约束求解器生成课表 THEN 排课系统 SHALL 确保每个班级的每门课程总课时数达到教学计划中设定的目标课时数
3. WHEN 约束求解器生成课表 THEN 排课系统 SHALL 确保同一教师在同一时间槽位只出现在一个班级
4. WHEN 约束求解器生成课表 THEN 排课系统 SHALL 确保同一班级在同一时间槽位只有一门课程
5. WHEN 约束求解器尝试为课程分配时间槽位 THEN 排课系统 SHALL 直接跳过该课程配置中标记为禁止的时间槽位
6. WHEN 课程配置中设置了不允许连堂 THEN 排课系统 SHALL 确保该课程不会被连续安排在相邻的两个节次

### 需求 2：软约束优化

**用户故事：** 作为教务主任，我希望系统能够考虑教师的个性化偏好，生成更人性化的课表，提高教师满意度。

#### 验收标准

1. WHEN 约束求解器生成课表 THEN 排课系统 SHALL 计算每个课表方案的代价值，代价值基于软约束违反情况
2. WHEN 教师设置了偏好时间槽位掩码 THEN 排课系统 SHALL 使用位运算检查安排的时段是否在教师偏好掩码中
3. WHEN 安排的时段不在教师偏好掩码中 THEN 排课系统 SHALL 在代价值中增加 10 乘以教师权重系数的惩罚分
4. WHEN 教师的早晚偏好设置为厌恶早课（time_bias = 1）且被安排第1节课 THEN 排课系统 SHALL 在代价值中增加 50 分惩罚
5. WHEN 教师的早晚偏好设置为厌恶晚课（time_bias = 2）且被安排第8节课 THEN 排课系统 SHALL 在代价值中增加 50 分惩罚
6. WHEN 教师设置了权重系数 THEN 排课系统 SHALL 在计算惩罚分时将惩罚值乘以该教师的权重系数
7. WHEN 主科课程被连续安排3节 THEN 排课系统 SHALL 在课表代价计算中增加惩罚分
8. WHEN 约束求解器生成多个可行课表方案 THEN 排课系统 SHALL 选择代价值最低的方案作为最优解

### 需求 3：教师偏好配置

**用户故事：** 作为教务主任，我希望能够为每位教师配置个性化的上课偏好，以便系统生成更符合实际需求的课表。

#### 验收标准

1. WHEN 用户为教师配置偏好 THEN 排课系统 SHALL 允许设置教师的偏好时间槽位掩码（TimeSlotMask）
2. WHEN 用户设置偏好时间槽位掩码 THEN 排课系统 SHALL 使用 u64 类型表示一周的时间槽位（5天 × 8节 = 40位）
3. WHEN 用户为教师配置偏好 THEN 排课系统 SHALL 允许设置教师的早晚出勤偏好（0=无偏好、1=厌恶早课、2=厌恶晚课）
4. WHEN 用户为教师配置偏好 THEN 排课系统 SHALL 允许设置教师的重要性权重系数（u32 类型）
5. WHEN 用户在设置向导中批量配置教师 THEN 排课系统 SHALL 允许勾选多位教师并统一设置相同的偏好属性
6. WHEN 用户保存教师偏好配置 THEN 排课系统 SHALL 将配置序列化为 JSON 并持久化到 SQLite 数据库的 teacher_preferences 表
7. WHEN 约束求解器需要教师偏好数据 THEN 排课系统 SHALL 从数据库加载教师偏好配置并传递给求解器

### 需求 4：课程配置管理

**用户故事：** 作为教务主任，我希望能够为不同科目配置特定的排课规则，以满足不同课程的特殊要求。

#### 验收标准

1. WHEN 用户创建课程配置 THEN 排课系统 SHALL 允许设置课程的唯一标识符和名称
2. WHEN 用户创建课程配置 THEN 排课系统 SHALL 允许设置课程的禁止时间槽位掩码
3. WHEN 用户创建课程配置 THEN 排课系统 SHALL 允许设置课程是否允许连堂
4. WHEN 用户保存课程配置 THEN 排课系统 SHALL 将配置持久化到数据库
5. WHEN 约束求解器生成课表 THEN 排课系统 SHALL 加载所有课程配置并应用其约束规则

### 需求 5：教学计划管理

**用户故事：** 作为教务主任，我希望能够为每个班级配置教学计划，明确每门课程的任课教师和课时数。

#### 验收标准

1. WHEN 用户创建教学计划 THEN 排课系统 SHALL 允许指定班级、科目、教师和目标课时数
2. WHEN 用户保存教学计划 THEN 排课系统 SHALL 验证总课时数不超过每周可用时间槽位数量
3. WHEN 总课时数超过容量 THEN 排课系统 SHALL 显示警告信息并阻止保存
4. WHEN 约束求解器生成课表 THEN 排课系统 SHALL 确保每个教学计划的课时数目标被满足
5. WHEN 用户修改教学计划 THEN 排课系统 SHALL 自动重新计算总课时数并更新验证状态

### 需求 6：自动排课生成

**用户故事：** 作为教务主任，我希望系统能够自动生成满足所有约束的课表，节省手动排课的时间和精力。

#### 验收标准

1. WHEN 用户触发自动排课 THEN 约束求解器 SHALL 使用 Rust 后端执行约束满足算法
2. WHEN 约束求解器搜索解空间 THEN 约束求解器 SHALL 使用 u64 位掩码技术表示和操作时间槽位以提高性能
3. WHEN 约束求解器搜索解空间 THEN 约束求解器 SHALL 通过剪枝策略排除违反硬约束的方案
4. WHEN 约束求解器为体育、音乐或美术课程寻找时间槽位 THEN 约束求解器 SHALL 直接从第4节开始搜索，跳过第1-3节
5. WHEN 约束求解器计算时间槽位的位表示 THEN 约束求解器 SHALL 使用公式 `1 << (day * 8 + period)` 计算槽位位
6. WHEN 约束求解器检查时间槽位冲突 THEN 约束求解器 SHALL 使用位与运算检查槽位是否被占用
7. WHEN 约束求解器找到可行解 THEN 约束求解器 SHALL 调用 calculate_cost 函数计算每个解的代价值
8. WHEN 约束求解器完成搜索 THEN 约束求解器 SHALL 返回代价值最低的课表方案
9. WHEN 约束求解器无法找到满足所有硬约束的解 THEN 排课系统 SHALL 返回错误信息并提示用户调整配置
10. WHEN 约束求解器生成课表 THEN 排课系统 SHALL 将结果保存到数据库并在前端显示

### 需求 7：可视化冲突检测

**用户故事：** 作为教务主任，我希望在手动调整课表时能够实时看到哪些时间槽位可用、哪些被禁止、哪些违反偏好，以便做出明智的调整决策。

#### 验收标准

1. WHEN 用户点击课表中的某节课 THEN 冲突检测器 SHALL 高亮显示该教师和该班级的所有空闲时间槽位为绿色
2. WHEN 用户点击课表中的某节课 THEN 冲突检测器 SHALL 将违反硬约束的时间槽位标记为灰色并显示禁止图标
3. WHEN 用户点击课表中的某节课 THEN 冲突检测器 SHALL 将违反软约束的时间槽位标记为黄色并显示警告提示
4. WHEN 用户拖拽课程到某个时间槽位 THEN 冲突检测器 SHALL 实时检测该位置是否存在冲突
5. WHEN 拖拽目标位置违反硬约束 THEN 冲突检测器 SHALL 阻止放置并显示错误提示
6. WHEN 拖拽目标位置违反软约束 THEN 冲突检测器 SHALL 允许放置但显示警告信息
7. WHEN 用户将鼠标悬停在黄色警告槽位上 THEN 排课系统 SHALL 显示具体的软约束违反详情

### 需求 8：智能调课与交换建议

**用户故事：** 作为教务主任，我希望系统能够在我手动调课时提供智能的交换建议，帮助我快速解决冲突。

#### 验收标准

1. WHEN 用户尝试将课程移动到已被占用的时间槽位 THEN 交换建议器 SHALL 自动计算可行的交换方案
2. WHEN 交换建议器检测到目标槽位被占用 THEN 交换建议器 SHALL 调用 suggest_swaps 函数获取交换选项
3. WHEN 交换建议器计算交换方案 THEN 交换建议器 SHALL 调用 find_valid_slots 函数寻找能够容纳被占用课程的其他有效时间槽位
4. WHEN 交换建议器找到可行方案 THEN 排课系统 SHALL 显示交换建议弹窗，格式为"将原来的[科目名]移至[星期][节次]，以腾出空间给[科目名]"
5. WHEN 用户选择某个交换方案 THEN 调课引擎 SHALL 自动执行课程交换并更新课表
6. WHEN 交换建议器无法找到简单交换方案 THEN 交换建议器 SHALL 尝试计算三角交换或链式交换方案
7. WHEN 交换建议器计算完成 THEN 排课系统 SHALL 显示每个交换方案对软约束的影响评估
8. WHEN 用户执行交换后 THEN 排课系统 SHALL 重新计算课表的总代价值并更新显示
9. WHEN 交换建议弹窗显示 THEN 排课系统 SHALL 提供"自动交换"按钮供用户一键执行建议方案

### 需求 9：设置向导

**用户故事：** 作为教务主任，我希望在首次使用系统时有一个引导流程，帮助我完成所有必要的配置。

#### 验收标准

1. WHEN 用户首次启动系统 THEN 设置向导 SHALL 自动显示并引导用户完成配置
2. WHEN 设置向导进入步骤1 THEN 设置向导 SHALL 允许用户配置全校通用的硬约束规则
3. WHEN 设置向导进入步骤2 THEN 设置向导 SHALL 显示所有教师列表并允许批量设置教师偏好
4. WHEN 设置向导进入步骤3 THEN 设置向导 SHALL 显示所有班级的总课时数并自动验证是否超过容量
5. WHEN 某个班级总课时数超过容量 THEN 设置向导 SHALL 以红色文字显示警告并阻止进入下一步
6. WHEN 用户完成所有配置步骤 THEN 设置向导 SHALL 保存所有配置并关闭向导界面
7. WHEN 用户需要修改配置 THEN 排课系统 SHALL 允许从设置菜单重新打开设置向导

### 需求 10：课表结果视图

**用户故事：** 作为教务主任，我希望能够以多种方式查看生成的课表，快速识别问题和优化空间。

#### 验收标准

1. WHEN 约束求解器生成课表 THEN 排课系统 SHALL 以网格形式显示完整的课表，行为班级，列为时间槽位
2. WHEN 用户查看课表 THEN 排课系统 SHALL 在每个单元格中显示科目名称和教师姓名
3. WHEN 用户启用热力图模式 THEN 排课系统 SHALL 根据软约束违反程度为单元格着色
4. WHEN 热力图模式启用 THEN 排课系统 SHALL 使用颜色深度表示违反程度，颜色越深表示违反越严重
5. WHEN 用户点击热力图中的单元格 THEN 排课系统 SHALL 显示该课程违反的具体软约束详情
6. WHEN 用户切换视图模式 THEN 排课系统 SHALL 允许按教师视图、班级视图或教室视图显示课表
7. WHEN 用户导出课表 THEN 排课系统 SHALL 支持导出为 PDF、Excel 或图片格式

### 需求 11：手动调课操作

**用户故事：** 作为教务主任，我希望能够通过拖拽方式手动调整课表，以应对临时变化和特殊需求。

#### 验收标准

1. WHEN 用户在课表上拖拽某节课 THEN 排课系统 SHALL 实时显示可放置的目标位置
2. WHEN 用户将课程拖拽到有效位置 THEN 调课引擎 SHALL 更新课表数据并刷新显示
3. WHEN 用户将课程拖拽到无效位置 THEN 排课系统 SHALL 拒绝放置并将课程返回原位置
4. WHEN 用户完成拖拽操作 THEN 排课系统 SHALL 自动保存更改到数据库
5. WHEN 用户执行调课操作 THEN 排课系统 SHALL 记录操作历史以支持撤销功能
6. WHEN 用户点击撤销按钮 THEN 排课系统 SHALL 恢复到上一个课表状态
7. WHEN 用户点击重做按钮 THEN 排课系统 SHALL 恢复被撤销的操作

### 需求 12：性能优化

**用户故事：** 作为系统用户，我希望系统能够快速响应，即使处理26个班级的复杂排课问题也能在合理时间内完成。

#### 验收标准

1. WHEN 约束求解器表示时间槽位 THEN 约束求解器 SHALL 使用 u64 位掩码而非数组或列表
2. WHEN 约束求解器计算代价函数 THEN 约束求解器 SHALL 使用引用而非克隆数据以避免内存分配
3. WHEN 约束求解器执行位运算 THEN 约束求解器 SHALL 使用位与、位或等操作检查时间槽位状态
4. WHEN 前端渲染课表 THEN 排课系统 SHALL 使用虚拟滚动技术处理大量数据
5. WHEN 用户执行拖拽操作 THEN 排课系统 SHALL 在 100 毫秒内完成冲突检测并更新 UI
6. WHEN 约束求解器生成课表 THEN 约束求解器 SHALL 在 30 秒内完成 26 个班级的排课计算

### 需求 13：数据持久化

**用户故事：** 作为系统用户，我希望所有配置和课表数据能够可靠地保存，以便随时恢复和查看。

#### 验收标准

1. WHEN 排课系统启动 THEN 排课系统 SHALL 使用 SQLite 数据库存储所有数据
2. WHEN 用户保存教师偏好 THEN 排课系统 SHALL 将偏好配置序列化为 JSON 并存储到 teacher_preferences 表
3. WHEN 用户保存课程配置 THEN 排课系统 SHALL 将配置存储到 subject_configs 表
4. WHEN 用户保存教学计划 THEN 排课系统 SHALL 将计划存储到 class_curriculums 表
5. WHEN 约束求解器生成课表 THEN 排课系统 SHALL 将课表数据存储到 schedules 表
6. WHEN 排课系统启动 THEN 排课系统 SHALL 自动加载最近一次保存的课表和配置
7. WHEN 数据库操作失败 THEN 排课系统 SHALL 显示错误信息并保持当前状态不变

### 需求 14：错误处理与验证

**用户故事：** 作为系统用户，我希望系统能够及时发现和提示配置错误，避免生成无效的课表。

#### 验收标准

1. WHEN 用户输入无效的课时数 THEN 排课系统 SHALL 显示错误提示并阻止保存
2. WHEN 用户配置的教学计划存在冲突 THEN 排课系统 SHALL 在保存前检测并提示冲突详情
3. WHEN 约束求解器无法找到可行解 THEN 排课系统 SHALL 返回详细的失败原因和建议
4. WHEN 数据库连接失败 THEN 排课系统 SHALL 显示友好的错误信息并提供重试选项
5. WHEN 用户尝试删除正在使用的教师或课程 THEN 排课系统 SHALL 阻止删除并提示依赖关系
6. WHEN 系统发生未预期的错误 THEN 排课系统 SHALL 记录错误日志并显示通用错误提示

### 需求 15：用户界面交互

**用户故事：** 作为系统用户，我希望界面简洁直观，能够快速完成各种操作。

#### 验收标准

1. WHEN 用户打开应用 THEN 排课系统 SHALL 显示主界面，包含课表视图和操作菜单
2. WHEN 用户点击"自动排课"按钮 THEN 排课系统 SHALL 显示进度指示器并在后台执行排课
3. WHEN 排课过程中 THEN 排课系统 SHALL 允许用户取消操作并返回上一个状态
4. WHEN 用户右键点击课表单元格 THEN 排课系统 SHALL 显示上下文菜单，包含编辑、删除、查看详情等选项
5. WHEN 用户使用键盘快捷键 THEN 排课系统 SHALL 支持常用操作的快捷键（如 Ctrl+Z 撤销）
6. WHEN 系统执行耗时操作 THEN 排课系统 SHALL 显示加载动画或进度条以提供反馈
7. WHEN 操作成功完成 THEN 排课系统 SHALL 显示成功提示消息并自动消失

### 需求 16：开发优先级与实现策略

**用户故事：** 作为开发团队，我希望按照合理的优先级顺序实现功能，确保系统能够逐步从可用到好用。

#### 验收标准

1. WHEN 开发团队规划实现顺序 THEN 排课系统 SHALL 首先实现硬约束功能（体音美限时、总课时达标、教师时间冲突检测）
2. WHEN 硬约束功能完成后 THEN 排课系统 SHALL 实现基础调课功能（手动拖拽、冲突检测）
3. WHEN 基础调课功能完成后 THEN 排课系统 SHALL 实现软约束优化功能（教师偏好、代价函数计算）
4. WHEN 软约束优化完成后 THEN 排课系统 SHALL 实现智能交换建议功能（三角交换、链式交换）
5. WHEN 实现代价函数计算 THEN 约束求解器 SHALL 使用引用而非克隆数据以避免内存分配开销
6. WHEN 实现位运算操作 THEN 约束求解器 SHALL 使用位与、位或等操作而非循环遍历以提高性能
7. WHEN 处理26个班级的排课计算 THEN 约束求解器 SHALL 优化算法以避免性能陷阱

### 需求 17：Tauri 命令接口

**用户故事：** 作为前端开发者，我希望有清晰的 Tauri 命令接口与 Rust 后端通信，实现前后端分离。

#### 验收标准

1. WHEN 前端需要获取交换建议 THEN 排课系统 SHALL 提供 suggest_swaps Tauri 命令接口
2. WHEN 前端调用 suggest_swaps 命令 THEN 排课系统 SHALL 接收参数：current_schedule、target_class、target_teacher、desired_slot
3. WHEN suggest_swaps 命令执行成功 THEN 排课系统 SHALL 返回 Vec<SwapOption> 类型的交换选项列表
4. WHEN suggest_swaps 命令执行失败 THEN 排课系统 SHALL 返回包含错误信息的 Result::Err
5. WHEN 前端需要生成课表 THEN 排课系统 SHALL 提供 generate_schedule Tauri 命令接口
6. WHEN 前端需要计算代价值 THEN 排课系统 SHALL 提供 calculate_cost Tauri 命令接口
7. WHEN 前端需要验证课表有效性 THEN 排课系统 SHALL 提供 validate_schedule Tauri 命令接口


### 需求 18：直观的卡片式调课界面

**用户故事：** 作为教务主任，我希望使用卡片式界面进行调课，通过不同颜色直观地看到哪些课可以调、哪些不能调。

#### 验收标准

1. WHEN 用户进入调课模式 THEN 排课系统 SHALL 以卡片形式显示每节课程
2. WHEN 用户选中某节课 THEN 排课系统 SHALL 用绿色标记可调换的时间槽位
3. WHEN 用户选中某节课 THEN 排课系统 SHALL 用红色标记不可调换的时间槽位（违反硬约束）
4. WHEN 用户选中某节课 THEN 排课系统 SHALL 用黄色标记不推荐调换的时间槽位（违反软约束）
5. WHEN 用户拖拽课程卡片 THEN 排课系统 SHALL 实时更新可放置区域的颜色标记
6. WHEN 用户完成调课 THEN 排课系统 SHALL 自动验证调整后的课表是否符合所有约束

### 需求 19：教师和班级查询功能

**用户故事：** 作为学校领导，我希望能够快速查询某个时间段哪些老师在上课、哪些在休息，方便安排临时工作或考勤查岗。

#### 验收标准

1. WHEN 用户选中课表中某一节课或多节课 THEN 排课系统 SHALL 显示该时段所有在上课的教师列表
2. WHEN 用户选中课表中某一节课或多节课 THEN 排课系统 SHALL 显示该时段所有空闲的教师列表
3. WHEN 用户选中课表中某一节课或多节课 THEN 排课系统 SHALL 显示该时段所有在上课的班级列表
4. WHEN 用户选中课表中某一节课或多节课 THEN 排课系统 SHALL 显示该时段所有空闲的班级列表
5. WHEN 用户查看教师状态 THEN 排课系统 SHALL 显示教师当前所在的班级和授课科目
6. WHEN 用户导出查询结果 THEN 排课系统 SHALL 支持导出为 Excel 或 PDF 格式
7. WHEN 用户在调课过程中使用查询功能 THEN 排课系统 SHALL 帮助发现不合理的课程安排

### 需求 20：教学工作量统计

**用户故事：** 作为教务主任，我希望系统能够自动统计全校任课教师的教学工作量，并导出到 Excel 中进行编辑和打印。

#### 验收标准

1. WHEN 用户触发工作量统计 THEN 排课系统 SHALL 自动计算每位教师的总课时数
2. WHEN 用户触发工作量统计 THEN 排课系统 SHALL 统计每位教师每周的授课班级数量
3. WHEN 用户触发工作量统计 THEN 排课系统 SHALL 统计每位教师的不同科目授课情况
4. WHEN 用户触发工作量统计 THEN 排课系统 SHALL 计算每位教师的早课、晚课节数
5. WHEN 用户导出工作量统计 THEN 排课系统 SHALL 生成包含教师姓名、科目、班级、总课时、早课数、晚课数的 Excel 文件
6. WHEN 用户导出工作量统计 THEN 排课系统 SHALL 在 Excel 中提供可编辑的工作量津贴计算公式模板
7. WHEN 用户查看工作量统计 THEN 排课系统 SHALL 在界面中以表格形式显示统计结果并支持排序和筛选


### 需求 21：场地受限课程的合理分配

**用户故事：** 作为教务主任，我希望系统能够自动处理场地受限的课程（如微机课、体育课），确保同一时段不会超过场地容量。

#### 验收标准

1. WHEN 用户配置场地信息 THEN 排课系统 SHALL 允许设置场地名称和容量（可同时容纳的班级数）
2. WHEN 用户将课程关联到场地 THEN 排课系统 SHALL 记录课程与场地的绑定关系
3. WHEN 约束求解器生成课表 THEN 排课系统 SHALL 确保同一时段使用同一场地的课程数不超过场地容量
4. WHEN 场地容量为1（如只有一间微机教室） THEN 排课系统 SHALL 确保同一时段只安排一节微机课
5. WHEN 用户手动调课 THEN 排课系统 SHALL 检测场地冲突并阻止违反场地容量限制的操作
6. WHEN 用户查看场地使用情况 THEN 排课系统 SHALL 提供场地课表视图，显示每个场地的使用时间表
7. WHEN 约束求解器无法满足场地约束 THEN 排课系统 SHALL 提示用户增加场地或减少相关课程数量

### 需求 22：固定课程安排

**用户故事：** 作为教务主任，我希望能够将某些课程（如班会课、劳动课、自习课）固定在特定的时间槽位。

#### 验收标准

1. WHEN 用户配置固定课程 THEN 排课系统 SHALL 允许指定课程、班级和固定的时间槽位
2. WHEN 约束求解器生成课表 THEN 排课系统 SHALL 首先安排所有固定课程到指定位置
3. WHEN 约束求解器生成课表 THEN 排课系统 SHALL 将固定课程占用的时间槽位标记为不可用
4. WHEN 用户尝试手动调整固定课程 THEN 排课系统 SHALL 显示警告并要求确认是否解除固定
5. WHEN 固定课程与其他约束冲突 THEN 排课系统 SHALL 在配置阶段提示冲突并阻止保存
6. WHEN 用户查看课表 THEN 排课系统 SHALL 用特殊标记（如图钉图标）标识固定课程
7. WHEN 用户批量设置固定课程 THEN 排课系统 SHALL 支持为多个班级同时设置相同时段的固定课程

### 需求 23：教师不排课节次设置

**用户故事：** 作为教务主任，我希望能够灵活设置某些教师在特定时段不排课，以适应教师的个人安排（如开会、进修等）。

#### 验收标准

1. WHEN 用户为教师设置不排课节次 THEN 排课系统 SHALL 允许选择具体的日期和节次
2. WHEN 用户为教师设置不排课节次 THEN 排课系统 SHALL 支持设置单次不排课或周期性不排课
3. WHEN 约束求解器生成课表 THEN 排课系统 SHALL 将教师不排课的时间槽位视为硬约束，不安排任何课程
4. WHEN 用户手动调课 THEN 排课系统 SHALL 阻止将课程拖拽到教师不排课的时间槽位
5. WHEN 用户查看教师课表 THEN 排课系统 SHALL 在不排课时段显示特殊标记（如"会议"、"请假"等备注）
6. WHEN 用户批量设置不排课节次 THEN 排课系统 SHALL 支持为多位教师同时设置相同的不排课时段
7. WHEN 教师不排课设置与已有课表冲突 THEN 排课系统 SHALL 提示冲突的课程列表并要求用户处理

### 需求 24：课程不排节次设置

**用户故事：** 作为教务主任，我希望能够为特定课程设置不排节次，例如体育课不安排在上午第一、二节。

#### 验收标准

1. WHEN 用户为课程设置不排节次 THEN 排课系统 SHALL 允许选择禁止的节次范围
2. WHEN 用户为课程设置不排节次 THEN 排课系统 SHALL 支持设置每日禁止节次或特定星期的禁止节次
3. WHEN 约束求解器生成课表 THEN 排课系统 SHALL 将课程不排节次视为硬约束，跳过这些时间槽位
4. WHEN 用户手动调课 THEN 排课系统 SHALL 阻止将该课程拖拽到禁止的节次
5. WHEN 用户配置课程不排节次 THEN 排课系统 SHALL 在课程配置界面提供可视化的时间槽位选择器
6. WHEN 用户保存课程不排节次配置 THEN 排课系统 SHALL 验证是否有足够的可用时间槽位满足课时需求
7. WHEN 可用时间槽位不足 THEN 排课系统 SHALL 显示警告并建议调整禁止节次或减少课时数


### 需求 25：灵活的打印和导出功能

**用户故事：** 作为教务主任，我希望能够方便地打印和导出各种格式的课表，包括班级课表、教师个人课表和总课表。

#### 验收标准

1. WHEN 用户触发导出功能 THEN 排课系统 SHALL 支持导出班级课表、教师课表和总课表
2. WHEN 用户导出到 Excel THEN 排课系统 SHALL 使用预定义的班级课表模板和教师课表模板
3. WHEN 用户导出到 Excel THEN 排课系统 SHALL 允许用户在导出前选择或自定义模板样式
4. WHEN 用户导出班级课表 THEN 排课系统 SHALL 为每个班级生成独立的工作表或文件
5. WHEN 用户导出教师课表 THEN 排课系统 SHALL 为每位教师生成独立的工作表或文件
6. WHEN 用户导出总课表 THEN 排课系统 SHALL 生成包含所有班级和教师的汇总视图
7. WHEN 用户一键导出 THEN 排课系统 SHALL 在3秒内完成所有课表的导出操作
8. WHEN 用户打印课表 THEN 排课系统 SHALL 提供打印预览功能并支持页面设置

### 需求 26：临时调课和调课通知

**用户故事：** 作为教务主任，我希望能够处理学期中途的临时调课需求，并自动生成调课通知发送给相关教师。

#### 验收标准

1. WHEN 用户创建临时调课 THEN 排课系统 SHALL 允许指定调课的起止日期范围
2. WHEN 用户创建临时调课 THEN 排课系统 SHALL 基于原课表生成临时课表副本
3. WHEN 用户在临时课表中调整课程 THEN 排课系统 SHALL 记录所有变更并标记受影响的教师和班级
4. WHEN 用户保存临时调课 THEN 排课系统 SHALL 自动生成调课通知文档
5. WHEN 系统生成调课通知 THEN 排课系统 SHALL 包含调课日期、原课程信息、新课程信息和受影响的教师、班级
6. WHEN 用户打印调课通知 THEN 排课系统 SHALL 为每位受影响的教师生成个性化的调课通知单
7. WHEN 临时调课期结束 THEN 排课系统 SHALL 自动恢复到原课表
8. WHEN 用户需要将临时调课转为永久调整 THEN 排课系统 SHALL 提供一键应用到原课表的功能

### 需求 27：单双周课表和合班课表

**用户故事：** 作为教务主任，我希望系统能够支持单双周轮换的课表，以及多个班级合并上课的合班课表。

#### 验收标准

1. WHEN 用户启用单双周模式 THEN 排课系统 SHALL 允许为每节课设置单周、双周或每周标记
2. WHEN 约束求解器生成单双周课表 THEN 排课系统 SHALL 分别生成单周课表和双周课表
3. WHEN 用户查看单双周课表 THEN 排课系统 SHALL 提供切换视图按钮在单周和双周之间切换
4. WHEN 用户配置合班课程 THEN 排课系统 SHALL 允许选择多个班级并指定合班上课的科目
5. WHEN 约束求解器生成合班课表 THEN 排课系统 SHALL 确保合班的所有班级在同一时段都空闲
6. WHEN 用户查看合班课表 THEN 排课系统 SHALL 在课表中显示合班标记和参与班级列表
7. WHEN 用户导出单双周课表 THEN 排课系统 SHALL 在导出文件中明确标注单周和双周的区别
8. WHEN 用户打印合班课表 THEN 排课系统 SHALL 在打印输出中清晰显示合班信息

### 需求 28：早晚自习课表

**用户故事：** 作为教务主任，我希望系统能够单独管理早自习和晚自习的课表，并与正课课表分开显示。

#### 验收标准

1. WHEN 用户配置早晚自习 THEN 排课系统 SHALL 允许设置早自习和晚自习的时间段
2. WHEN 用户配置早晚自习 THEN 排课系统 SHALL 允许指定哪些班级需要安排早晚自习
3. WHEN 约束求解器生成早晚自习课表 THEN 排课系统 SHALL 为每个班级分配辅导教师
4. WHEN 约束求解器生成早晚自习课表 THEN 排课系统 SHALL 确保辅导教师在该时段没有其他安排
5. WHEN 用户查看课表 THEN 排课系统 SHALL 提供独立的早晚自习课表视图
6. WHEN 用户导出课表 THEN 排课系统 SHALL 支持单独导出早晚自习课表或与正课合并导出
7. WHEN 用户打印教师课表 THEN 排课系统 SHALL 在教师课表中包含其负责的早晚自习安排


### 需求 29：教师互斥约束

**用户故事：** 作为教务主任，我希望能够设置某两位教师在任意节次上课程"互斥"，即两位教师不能同时上课。

#### 验收标准

1. WHEN 用户配置教师互斥关系 THEN 排课系统 SHALL 允许选择两位教师并设置互斥约束
2. WHEN 用户配置教师互斥关系 THEN 排课系统 SHALL 支持设置全时段互斥或特定时段互斥
3. WHEN 约束求解器生成课表 THEN 排课系统 SHALL 将教师互斥关系视为硬约束
4. WHEN 约束求解器为教师A安排课程 THEN 排课系统 SHALL 确保教师B在同一时段没有课程
5. WHEN 用户手动调课 THEN 排课系统 SHALL 检测互斥冲突并阻止违反互斥约束的操作
6. WHEN 用户查看互斥关系 THEN 排课系统 SHALL 提供互斥关系列表视图并支持编辑和删除
7. WHEN 互斥约束导致无解 THEN 排课系统 SHALL 提示用户调整互斥关系或课时安排

### 需求 30：从 Excel 导入排课条件

**用户故事：** 作为教务主任，我希望能够从 Excel 文件批量导入排课条件，避免手动逐条输入。

#### 验收标准

1. WHEN 用户选择导入功能 THEN 排课系统 SHALL 提供 Excel 模板下载链接
2. WHEN 用户下载模板 THEN 排课系统 SHALL 提供包含教师信息、课程配置、教学计划等多个工作表的模板文件
3. WHEN 用户上传 Excel 文件 THEN 排课系统 SHALL 验证文件格式和数据完整性
4. WHEN Excel 数据验证通过 THEN 排课系统 SHALL 解析并导入教师信息、课程配置、教学计划、教师偏好等数据
5. WHEN Excel 数据验证失败 THEN 排课系统 SHALL 显示详细的错误报告，指出具体的错误行和错误原因
6. WHEN 导入数据与现有数据冲突 THEN 排课系统 SHALL 提供选项：覆盖、跳过或合并
7. WHEN 导入完成 THEN 排课系统 SHALL 显示导入摘要，包含成功导入的记录数和失败的记录数

### 需求 31：班级升级功能

**用户故事：** 作为教务主任，我希望在新学期开始时能够快速修改班级名称，例如将初一升级为初二，而不需要重新配置所有数据。

#### 验收标准

1. WHEN 用户触发班级升级功能 THEN 排课系统 SHALL 显示所有班级列表并提供批量重命名选项
2. WHEN 用户配置升级规则 THEN 排课系统 SHALL 支持正则表达式或模式匹配进行批量重命名
3. WHEN 用户执行班级升级 THEN 排课系统 SHALL 更新所有相关数据中的班级名称，包括教学计划、课表、统计数据等
4. WHEN 用户执行班级升级 THEN 排课系统 SHALL 保留所有历史课表数据并关联到新的班级名称
5. WHEN 班级升级完成 THEN 排课系统 SHALL 显示升级摘要，列出所有重命名的班级
6. WHEN 用户需要撤销升级 THEN 排课系统 SHALL 提供回滚功能恢复到升级前的状态
7. WHEN 用户导出升级后的数据 THEN 排课系统 SHALL 确保所有导出文件使用新的班级名称

### 需求 32：场地课表查询和打印

**用户故事：** 作为教务主任，我希望能够查询和打印特定场地（如操场、微机室、语音室）的使用课表。

#### 验收标准

1. WHEN 用户选择场地课表视图 THEN 排课系统 SHALL 显示所有已配置场地的列表
2. WHEN 用户选择特定场地 THEN 排课系统 SHALL 显示该场地的周课表，包含使用时段、班级和科目
3. WHEN 用户查看场地课表 THEN 排课系统 SHALL 高亮显示场地的空闲时段和已占用时段
4. WHEN 用户打印场地课表 THEN 排课系统 SHALL 生成包含场地名称、使用时间、班级、科目的格式化文档
5. WHEN 用户导出场地课表 THEN 排课系统 SHALL 支持导出为 Excel 或 PDF 格式
6. WHEN 用户查询场地使用率 THEN 排课系统 SHALL 统计并显示每个场地的使用率百分比
7. WHEN 用户需要调整场地使用 THEN 排课系统 SHALL 在场地课表视图中支持直接拖拽调整

### 需求 33：分教研组显示教师

**用户故事：** 作为教务主任，我希望能够按教研组分类显示教师名单，方便按学科管理教师信息。

#### 验收标准

1. WHEN 用户配置教师信息 THEN 排课系统 SHALL 允许为每位教师指定所属教研组
2. WHEN 用户查看教师列表 THEN 排课系统 SHALL 提供按教研组分组显示的视图
3. WHEN 用户选择特定教研组 THEN 排课系统 SHALL 只显示该教研组的教师列表
4. WHEN 用户统计工作量 THEN 排课系统 SHALL 支持按教研组汇总统计数据
5. WHEN 用户导出教师信息 THEN 排课系统 SHALL 支持按教研组分别导出或合并导出
6. WHEN 用户批量设置教师属性 THEN 排课系统 SHALL 支持按教研组批量应用设置
7. WHEN 用户查看教研组课表 THEN 排课系统 SHALL 提供教研组汇总视图，显示该组所有教师的课程安排


### 需求 34：课表中显示作息时间

**用户故事：** 作为教务主任，我希望在课表中显示作息时间，方便教师和学生了解每节课的具体上课时间。

#### 验收标准

1. WHEN 用户配置作息时间 THEN 排课系统 SHALL 允许为每个节次设置开始时间和结束时间
2. WHEN 用户配置作息时间 THEN 排课系统 SHALL 支持设置课间休息时间
3. WHEN 用户查看课表 THEN 排课系统 SHALL 提供选项控制是否在课表中显示作息时间
4. WHEN 作息时间显示启用 THEN 排课系统 SHALL 在每个时间槽位旁边显示对应的上课时间段
5. WHEN 用户打印课表 THEN 排课系统 SHALL 在打印输出中包含作息时间信息
6. WHEN 用户导出课表 THEN 排课系统 SHALL 在导出的 Excel 文件中包含作息时间列
7. WHEN 用户修改作息时间 THEN 排课系统 SHALL 自动更新所有课表视图中的时间显示

### 需求 35：手动预排课功能

**用户故事：** 作为教务主任，我希望能够手动预先排好难排的课程，然后让系统自动排剩余的课程，最后还能手动调整。

#### 验收标准

1. WHEN 用户进入预排课模式 THEN 排课系统 SHALL 显示空白课表供用户手动安排课程
2. WHEN 用户手动预排课程 THEN 排课系统 SHALL 实时检测并提示硬约束冲突
3. WHEN 用户完成预排课 THEN 排课系统 SHALL 将预排的课程标记为固定课程
4. WHEN 用户触发自动排课 THEN 约束求解器 SHALL 保留所有预排课程并只排列剩余课程
5. WHEN 约束求解器生成剩余课表 THEN 排课系统 SHALL 将预排课程占用的时间槽位视为不可用
6. WHEN 自动排课完成 THEN 排课系统 SHALL 允许用户手动调整任何课程，包括预排的课程
7. WHEN 用户调整预排课程 THEN 排课系统 SHALL 提示该课程原为预排课程并要求确认

### 需求 36：同一教师多班课进度一致

**用户故事：** 作为教务主任，我希望系统在排课时考虑同一教师教多个班级的情况，尽量让这些班级的课程进度保持一致。

#### 验收标准

1. WHEN 约束求解器检测到同一教师教多个班级同一科目 THEN 排课系统 SHALL 识别这些课程为进度关联课程
2. WHEN 约束求解器生成课表 THEN 排课系统 SHALL 尽量将进度关联课程安排在相近的时间
3. WHEN 约束求解器计算代价函数 THEN 排课系统 SHALL 对进度关联课程的时间差异增加惩罚分
4. WHEN 进度关联课程时间差超过2天 THEN 排课系统 SHALL 在代价函数中增加额外惩罚
5. WHEN 用户查看教师课表 THEN 排课系统 SHALL 高亮显示进度关联的课程
6. WHEN 用户手动调整进度关联课程 THEN 排课系统 SHALL 提示其他关联课程的位置并建议同步调整
7. WHEN 用户启用进度一致性检查 THEN 排课系统 SHALL 生成进度一致性报告，显示所有教师的多班课程时间分布

### 需求 37：监考表排列功能

**用户故事：** 作为教务主任，我希望系统能够自动生成监考表，并智能处理跨年级教师在不同考场、不同时间的监考冲突。

#### 验收标准

1. WHEN 用户创建考试安排 THEN 排课系统 SHALL 允许设置考试科目、时间、考场和参考班级
2. WHEN 用户触发监考表生成 THEN 排课系统 SHALL 自动为每个考场分配监考教师
3. WHEN 系统分配监考教师 THEN 排课系统 SHALL 确保教师在同一时间只监考一个考场
4. WHEN 系统分配监考教师 THEN 排课系统 SHALL 避免让教师监考自己任教班级的考试
5. WHEN 系统分配监考教师 THEN 排课系统 SHALL 尽量平衡每位教师的监考次数
6. WHEN 跨年级教师在不同时间有监考安排 THEN 排课系统 SHALL 自动检测并解决时间冲突
7. WHEN 监考表生成完成 THEN 排课系统 SHALL 支持导出为 Excel 格式并提供打印功能
8. WHEN 用户手动调整监考安排 THEN 排课系统 SHALL 实时检测并提示监考冲突

### 需求 38：移动端课表查询

**用户故事：** 作为教师，我希望能够在智能手机上查询课表，方便随时查看自己的授课安排。

#### 验收标准

1. WHEN 用户导出课表 THEN 排课系统 SHALL 生成适配移动端的课表模板
2. WHEN 用户导出班级课表模板 THEN 排课系统 SHALL 生成可在 WPS Office 移动版中打开的格式
3. WHEN 用户导出教师课表模板 THEN 排课系统 SHALL 生成可在 WPS Office 移动版中打开的格式
4. WHEN 用户在手机上打开课表 THEN 课表 SHALL 自动适配手机屏幕尺寸
5. WHEN 用户在手机上查看课表 THEN 课表 SHALL 支持横屏和竖屏两种显示模式
6. WHEN 用户在手机上查看课表 THEN 课表 SHALL 支持缩放和滚动操作
7. WHEN 用户导出移动端课表 THEN 排课系统 SHALL 提供二维码或分享链接方便传输到手机


### 需求 39：灵活的排课周期（1-30天）

**用户故事：** 作为培训机构管理员，我希望系统能够支持1-30天的灵活排课周期，而不仅限于传统的5天工作周。

#### 验收标准

1. WHEN 用户配置排课周期 THEN 排课系统 SHALL 允许设置1-30天的任意周期长度
2. WHEN 用户配置排课周期 THEN 排课系统 SHALL 允许设置每天的节次数量（1-12节）
3. WHEN 用户配置排课周期 THEN 排课系统 SHALL 支持设置工作日和休息日
4. WHEN 约束求解器生成课表 THEN 排课系统 SHALL 根据配置的周期长度和节次数量调整时间槽位掩码
5. WHEN 周期长度超过8天 THEN 排课系统 SHALL 使用扩展的位掩码表示（超过 u64 容量时使用数组）
6. WHEN 用户查看课表 THEN 排课系统 SHALL 根据配置的周期长度动态调整课表显示列数
7. WHEN 用户导出课表 THEN 排课系统 SHALL 根据实际周期长度生成相应的课表格式
8. WHEN 培训机构使用系统 THEN 排课系统 SHALL 支持非连续的上课日期（如周一、周三、周五）

## 非功能性需求

### 性能需求

1. 排课系统 SHALL 在30秒内完成26个班级的自动排课计算
2. 排课系统 SHALL 在100毫秒内完成单次拖拽操作的冲突检测
3. 排课系统 SHALL 在3秒内完成所有课表的导出操作
4. 排课系统 SHALL 支持至少100位教师和50个班级的数据规模

### 可用性需求

1. 排课系统 SHALL 提供中文用户界面
2. 排课系统 SHALL 在首次使用时提供设置向导引导用户完成配置
3. 排课系统 SHALL 为所有主要功能提供工具提示和帮助文档
4. 排课系统 SHALL 在执行耗时操作时显示进度指示器

### 可靠性需求

1. 排课系统 SHALL 在数据库操作失败时保持当前状态不变
2. 排课系统 SHALL 自动保存用户的操作历史以支持撤销功能
3. 排课系统 SHALL 在异常情况下记录错误日志并显示友好的错误提示
4. 排课系统 SHALL 定期自动备份数据库文件

### 兼容性需求

1. 排课系统 SHALL 支持 Windows、macOS 和 Linux 操作系统
2. 排课系统 SHALL 导出的 Excel 文件兼容 Microsoft Excel 2016 及以上版本
3. 排课系统 SHALL 导出的 Excel 文件兼容 WPS Office 移动版
4. 排课系统 SHALL 导出的 PDF 文件符合 PDF/A 标准以确保长期可读性

### 可维护性需求

1. 排课系统 SHALL 使用 Rust 实现核心算法以确保类型安全和内存安全
2. 排课系统 SHALL 使用 SQLite 数据库以简化部署和维护
3. 排课系统 SHALL 提供清晰的代码文档和 API 文档
4. 排课系统 SHALL 使用模块化设计以便于功能扩展和维护

## 技术约束

1. 后端核心算法使用 Rust 语言实现
2. 前端使用 Bun 运行时和现代 JavaScript 框架（如 Svelte 或 React）
3. 桌面应用使用 Tauri 框架构建
4. 数据存储使用 SQLite 数据库
5. 时间槽位表示使用位掩码（Bitmask）技术
6. 约束求解使用约束优化问题（COP）算法
7. Excel 导入导出使用成熟的第三方库（如 rust_xlsxwriter）

## 术语补充

- **教研组（Teaching_Research_Group）**: 按学科划分的教师组织单位
- **场地（Venue）**: 具有容量限制的教学场所，如微机室、操场、语音室
- **固定课程（Fixed_Course）**: 被锁定在特定时间槽位的课程，不参与自动排课
- **临时课表（Temporary_Schedule）**: 为应对临时变化而创建的短期课表
- **单双周（Odd_Even_Week）**: 按周次轮换的课程安排模式
- **合班课（Combined_Class）**: 多个班级合并上课的课程
- **早晚自习（Morning_Evening_Study）**: 正课之外的自习时段
- **教师互斥（Teacher_Mutual_Exclusion）**: 两位教师不能同时上课的约束关系
- **进度关联课程（Progress_Related_Courses）**: 同一教师教授多个班级的同一科目课程
- **监考表（Invigilation_Schedule）**: 考试期间的监考人员安排表
- **排课周期（Scheduling_Cycle）**: 课表的时间跨度，可以是1-30天

