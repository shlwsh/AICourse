/**
 * 字典数据 Store
 * 管理从 Excel 导入的基础数据（教师、班级、科目、教学计划）
 */
import { defineStore } from 'pinia';
import { ref, computed } from 'vue';
import { logger } from '@/utils/logger';

/**
 * 教师数据接口
 */
export interface TeacherData {
  id?: number;
  name: string;
  teachingGroup?: string;
  maxHoursPerDay?: number;
  maxConsecutiveHours?: number;
  unavailableSlots?: string[];
  createdAt?: string;
  updatedAt?: string;
}

/**
 * 班级数据接口
 */
export interface ClassData {
  id?: number;
  name: string;
  grade?: string;
  studentCount?: number;
  createdAt?: string;
  updatedAt?: string;
}

/**
 * 科目数据接口
 */
export interface SubjectData {
  id?: number;
  name: string;
  category?: string;
  requiresLab?: boolean;
  createdAt?: string;
  updatedAt?: string;
}

/**
 * 教学计划数据接口
 */
export interface CurriculumData {
  id?: number;
  className: string;
  subjectName: string;
  teacherName: string;
  hoursPerWeek: number;
  requiresConsecutive?: boolean;
  createdAt?: string;
  updatedAt?: string;
}

/**
 * 教研组数据接口
 */
export interface TeachingGroupData {
  id?: number;
  name: string;
  description?: string;
  createdAt?: string;
  updatedAt?: string;
}

/**
 * 年级数据接口
 */
export interface GradeData {
  id?: number;
  name: string;
  order?: number;
  createdAt?: string;
  updatedAt?: string;
}

/**
 * 场地数据接口
 */
export interface VenueData {
  id?: number;
  name: string;
  capacity?: number;
  type?: string;
  createdAt?: string;
  updatedAt?: string;
}

/**
 * 字典数据 Store
 */
export const useDictionaryStore = defineStore('dictionary', () => {
  // ==================== 状态 ====================

  /** 教师列表 */
  const teachers = ref<TeacherData[]>([]);

  /** 班级列表 */
  const classes = ref<ClassData[]>([]);

  /** 科目列表 */
  const subjects = ref<SubjectData[]>([]);

  /** 教学计划列表 */
  const curriculums = ref<CurriculumData[]>([]);

  // ==================== 计算属性 ====================

  /** 教师数量 */
  const teacherCount = computed(() => teachers.value.length);

  /** 班级数量 */
  const classCount = computed(() => classes.value.length);

  /** 科目数量 */
  const subjectCount = computed(() => subjects.value.length);

  /** 教学计划数量 */
  const curriculumCount = computed(() => curriculums.value.length);

  // ==================== 方法 ====================

  /**
   * 设置教师数据
   */
  function setTeachers(data: TeacherData[]): void {
    const timestamp = new Date().toISOString();
    teachers.value = data.map((item, index) => ({
      ...item,
      id: item.id || index + 1,
      createdAt: item.createdAt || timestamp,
      updatedAt: item.updatedAt || timestamp,
    }));

    logger.info('[DictionaryStore] 设置教师数据', { count: teachers.value.length });
  }

  /**
   * 设置班级数据
   */
  function setClasses(data: ClassData[]): void {
    const timestamp = new Date().toISOString();
    classes.value = data.map((item, index) => ({
      ...item,
      id: item.id || index + 1,
      createdAt: item.createdAt || timestamp,
      updatedAt: item.updatedAt || timestamp,
    }));

    logger.info('[DictionaryStore] 设置班级数据', { count: classes.value.length });
  }

  /**
   * 设置科目数据
   */
  function setSubjects(data: SubjectData[]): void {
    const timestamp = new Date().toISOString();
    subjects.value = data.map((item, index) => ({
      ...item,
      id: item.id || index + 1,
      createdAt: item.createdAt || timestamp,
      updatedAt: item.updatedAt || timestamp,
    }));

    logger.info('[DictionaryStore] 设置科目数据', { count: subjects.value.length });
  }

  /**
   * 设置教学计划数据
   */
  function setCurriculums(data: CurriculumData[]): void {
    const timestamp = new Date().toISOString();
    curriculums.value = data.map((item, index) => ({
      ...item,
      id: item.id || index + 1,
      createdAt: item.createdAt || timestamp,
      updatedAt: item.updatedAt || timestamp,
    }));

    logger.info('[DictionaryStore] 设置教学计划数据', { count: curriculums.value.length });
  }

  /**
   * 从导入结果设置所有数据
   */
  function setImportedData(data: {
    teachers?: TeacherData[];
    classes?: ClassData[];
    subjects?: SubjectData[];
    curriculums?: CurriculumData[];
  }): void {
    logger.info('[DictionaryStore] 设置导入数据', {
      teachers: data.teachers?.length || 0,
      classes: data.classes?.length || 0,
      subjects: data.subjects?.length || 0,
      curriculums: data.curriculums?.length || 0,
    });

    if (data.teachers) {
      setTeachers(data.teachers);
    }
    if (data.classes) {
      setClasses(data.classes);
    }
    if (data.subjects) {
      setSubjects(data.subjects);
    }
    if (data.curriculums) {
      setCurriculums(data.curriculums);
    }
  }

  /**
   * 添加教师
   */
  function addTeacher(teacher: TeacherData): void {
    const timestamp = new Date().toISOString();
    const newTeacher = {
      ...teacher,
      id: teachers.value.length + 1,
      createdAt: timestamp,
      updatedAt: timestamp,
    };
    teachers.value.push(newTeacher);

    logger.info('[DictionaryStore] 添加教师', { name: teacher.name });
  }

  /**
   * 更新教师
   */
  function updateTeacher(id: number, teacher: Partial<TeacherData>): void {
      const index = teachers.value.findIndex(t => t.id === id);
      if (index !== -1) {
        const current = teachers.value[index];
        if (current) {
          teachers.value[index] = {
            ...current,
            ...teacher,
            name: teacher.name ?? current.name,
            updatedAt: new Date().toISOString(),
          };

          logger.info('[DictionaryStore] 更新教师', { id, name: teacher.name });
        }
      }
    }

  /**
   * 删除教师
   */
  function deleteTeacher(id: number): void {
      const index = teachers.value.findIndex(t => t.id === id);
      if (index !== -1) {
        const teacher = teachers.value[index];
        teachers.value.splice(index, 1);

        logger.info('[DictionaryStore] 删除教师', { id, name: teacher?.name });
      }
    }

  /**
   * 添加班级
   */
  function addClass(classData: ClassData): void {
    const timestamp = new Date().toISOString();
    const newClass = {
      ...classData,
      id: classes.value.length + 1,
      createdAt: timestamp,
      updatedAt: timestamp,
    };
    classes.value.push(newClass);

    logger.info('[DictionaryStore] 添加班级', { name: classData.name });
  }

  /**
   * 更新班级
   */
  function updateClass(id: number, classData: Partial<ClassData>): void {
      const index = classes.value.findIndex(c => c.id === id);
      if (index !== -1) {
        const current = classes.value[index];
        if (current) {
          classes.value[index] = {
            ...current,
            ...classData,
            name: classData.name ?? current.name,
            updatedAt: new Date().toISOString(),
          };

          logger.info('[DictionaryStore] 更新班级', { id, name: classData.name });
        }
      }
    }

  /**
   * 删除班级
   */
  function deleteClass(id: number): void {
      const index = classes.value.findIndex(c => c.id === id);
      if (index !== -1) {
        const classData = classes.value[index];
        classes.value.splice(index, 1);

        logger.info('[DictionaryStore] 删除班级', { id, name: classData?.name });
      }
    }

  /**
   * 添加科目
   */
  function addSubject(subject: SubjectData): void {
    const timestamp = new Date().toISOString();
    const newSubject = {
      ...subject,
      id: subjects.value.length + 1,
      createdAt: timestamp,
      updatedAt: timestamp,
    };
    subjects.value.push(newSubject);

    logger.info('[DictionaryStore] 添加科目', { name: subject.name });
  }

  /**
   * 更新科目
   */
  function updateSubject(id: number, subject: Partial<SubjectData>): void {
      const index = subjects.value.findIndex(s => s.id === id);
      if (index !== -1) {
        const current = subjects.value[index];
        if (current) {
          subjects.value[index] = {
            ...current,
            ...subject,
            name: subject.name ?? current.name,
            updatedAt: new Date().toISOString(),
          };

          logger.info('[DictionaryStore] 更新科目', { id, name: subject.name });
        }
      }
    }

  /**
   * 删除科目
   */
  function deleteSubject(id: number): void {
      const index = subjects.value.findIndex(s => s.id === id);
      if (index !== -1) {
        const subject = subjects.value[index];
        subjects.value.splice(index, 1);

        logger.info('[DictionaryStore] 删除科目', { id, name: subject?.name });
      }
    }

  /**
   * 添加教学计划
   */
  function addCurriculum(curriculum: CurriculumData): void {
    const timestamp = new Date().toISOString();
    const newCurriculum = {
      ...curriculum,
      id: curriculums.value.length + 1,
      createdAt: timestamp,
      updatedAt: timestamp,
    };
    curriculums.value.push(newCurriculum);

    logger.info('[DictionaryStore] 添加教学计划', {
      className: curriculum.className,
      subjectName: curriculum.subjectName,
    });
  }

  /**
   * 更新教学计划
   */
  function updateCurriculum(id: number, curriculum: Partial<CurriculumData>): void {
      const index = curriculums.value.findIndex(c => c.id === id);
      if (index !== -1) {
        const current = curriculums.value[index];
        if (current) {
          curriculums.value[index] = {
            ...current,
            ...curriculum,
            className: curriculum.className ?? current.className,
            subjectName: curriculum.subjectName ?? current.subjectName,
            teacherName: curriculum.teacherName ?? current.teacherName,
            hoursPerWeek: curriculum.hoursPerWeek ?? current.hoursPerWeek,
            updatedAt: new Date().toISOString(),
          };

          logger.info('[DictionaryStore] 更新教学计划', { id });
        }
      }
    }

  /**
   * 删除教学计划
   */
  function deleteCurriculum(id: number): void {
      const index = curriculums.value.findIndex(c => c.id === id);
      if (index !== -1) {
        curriculums.value.splice(index, 1);

        logger.info('[DictionaryStore] 删除教学计划', { id });
      }
    }

  /**
   * 清空所有数据
   */
  function clearAll(): void {
    teachers.value = [];
    classes.value = [];
    subjects.value = [];
    curriculums.value = [];

    logger.info('[DictionaryStore] 清空所有数据');
  }

  return {
    // 状态
    teachers,
    classes,
    subjects,
    curriculums,

    // 计算属性
    teacherCount,
    classCount,
    subjectCount,
    curriculumCount,

    // 方法
    setTeachers,
    setClasses,
    setSubjects,
    setCurriculums,
    setImportedData,
    addTeacher,
    updateTeacher,
    deleteTeacher,
    addClass,
    updateClass,
    deleteClass,
    addSubject,
    updateSubject,
    deleteSubject,
    addCurriculum,
    updateCurriculum,
    deleteCurriculum,
    clearAll,
  };
}, {
  persist: true, // 持久化存储
});
